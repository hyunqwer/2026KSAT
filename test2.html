<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 ìˆ˜ëŠ¥ ì˜ì–´ 21ë²ˆ ë§Œì ì ë¦¬í”Œë ˆì´</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Roboto+Mono:wght@500&display=swap');
        
        body { font-family: 'Noto Sans KR', sans-serif; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        
        /* Custom Animations */
        @keyframes zoomIn {
            from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .animate-zoom-in { animation: zoomIn 0.3s ease-out forwards; }
        
        .decoration-clone { -webkit-box-decoration-break: clone; box-decoration-break: clone; }
        
        /* Smooth transitions for highlights */
        .segment-transition { transition: all 0.3s ease-out; }
        
        /* Eye Tracker Dot Pulse */
        @keyframes trackerPulse {
            0% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.5); opacity: 0.3; }
            100% { transform: scale(1); opacity: 0.6; }
        }
        .tracker-dot { animation: trackerPulse 1.5s infinite; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen flex flex-col items-center justify-center">

    <!-- App Container -->
    <div id="app-container" class="w-full max-w-6xl h-screen md:h-[90vh] bg-white shadow-2xl rounded-none md:rounded-2xl overflow-hidden flex flex-col md:flex-row relative">
        
        <!-- Screen: Intro -->
        <div id="intro-screen" class="absolute inset-0 z-50 bg-slate-50 flex flex-col items-center justify-center p-4">
            <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center space-y-6">
                <div class="bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-full w-fit mx-auto">2026 ìˆ˜ëŠ¥ ì˜ì–´</div>
                <h1 class="text-2xl font-bold text-slate-800">21ë²ˆ ë§Œì ì ë¦¬í”Œë ˆì´</h1>
                
                <div class="bg-slate-50 p-4 rounded-xl text-left space-y-3">
                    <p class="font-bold text-slate-700 text-center mb-4 text-sm">ğŸ† ë§Œì ìì˜ 80ì´ˆ ì‹œí¬ë¦¿</p>
                    <div class="flex items-start gap-3 text-sm text-slate-600">
                        <i data-lucide="target" class="w-4 h-4 mt-0.5 text-red-500"></i>
                        <span><strong>0~10ì´ˆ:</strong> ë°‘ì¤„-ì •ì˜(Disconnected) ì—°ê²°</span>
                    </div>
                    <div class="flex items-start gap-3 text-sm text-slate-600">
                        <i data-lucide="zoom-in" class="w-4 h-4 mt-0.5 text-yellow-600"></i>
                        <span><strong>10~30ì´ˆ:</strong> 'Non-proximate' í•µì‹¬ í¬ì°©</span>
                    </div>
                    <div class="flex items-start gap-3 text-sm text-slate-600">
                        <i data-lucide="arrow-right-left" class="w-4 h-4 mt-0.5 text-green-500"></i>
                        <span><strong>30~55ì´ˆ:</strong> ì˜ˆì‹œë¡œ 'ìœ ì—°ì„±' ì‹œê°í™”</span>
                    </div>
                    <div class="flex items-start gap-3 text-sm text-slate-600">
                        <i data-lucide="check-square" class="w-4 h-4 mt-0.5 text-blue-500"></i>
                        <span><strong>55~80ì´ˆ:</strong> í•¨ì • íšŒí”¼ ë° ë…¼ë¦¬ í™•ì •</span>
                    </div>
                </div>
                
                <div class="space-y-3 pt-2">
                    <button onclick="startSolving()" class="w-full py-3 bg-white border-2 border-slate-200 text-slate-700 font-bold rounded-xl hover:bg-slate-50 hover:border-slate-300 transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="mouse-pointer-2" class="w-4 h-4"></i> ì§ì ‘ ë¨¼ì € í’€ì–´ë³´ê¸°
                    </button>
                    <button onclick="startReplay()" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200 flex items-center justify-center gap-2">
                        <i data-lucide="play" class="w-4 h-4"></i> ë§Œì ì ì‹œì„  ì²´í—˜í•˜ê¸° (80ì´ˆ)
                    </button>
                </div>
            </div>
        </div>

        <!-- Screen: Result (Hidden by default) -->
        <div id="result-screen" class="hidden absolute inset-0 z-50 bg-slate-50 flex flex-col items-center justify-center p-4">
            <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center space-y-6">
                <div id="result-icon-container" class="w-16 h-16 mx-auto rounded-full flex items-center justify-center bg-slate-100">
                    <!-- Icon injected by JS -->
                </div>
                <h2 id="result-title" class="text-xl font-bold text-slate-800">ê²°ê³¼</h2>
                <p class="text-slate-500">ë‚˜ì˜ ì‹œê°„: <span id="result-time" class="font-mono font-bold text-slate-700">0.0ì´ˆ</span></p>
                <button onclick="startReplay()" class="w-full py-4 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200 flex items-center justify-center gap-2 animate-pulse">
                    <i data-lucide="play" class="w-5 h-5"></i> ë§Œì ìì˜ í’€ì´ ê³¼ì • ë³´ê¸° (Replay)
                </button>
            </div>
        </div>

        <!-- Main Content: Left Panel (Passage) -->
        <div class="flex-1 bg-white p-6 md:p-10 flex flex-col relative overflow-y-auto">
            <div class="mb-6 flex justify-between items-center border-b pb-4">
                <div class="text-sm font-bold text-slate-500 tracking-wider">2026 ACADEMIC YEAR ENGLISH</div>
                <div id="timer-display" class="text-xl font-mono font-bold text-slate-800">0.0s</div>
            </div>

            <h3 class="text-lg font-bold mb-6 text-slate-800 leading-snug">
                21. ë°‘ì¤„ ì¹œ <span class="border-b-2 border-slate-900">made a lot of work less sticky</span>ê°€ ë‹¤ìŒ ê¸€ì—ì„œ ì˜ë¯¸í•˜ëŠ” ë°”ë¡œ ê°€ì¥ ì ì ˆí•œ ê²ƒì€?
            </h3>

            <!-- Text Body -->
            <div id="passage-body" class="text-lg leading-loose font-serif text-justify relative">
                <!-- Sentences injected by JS -->
                <div id="logic-match-overlay" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-blue-600/90 text-white p-4 rounded-2xl shadow-2xl z-50 animate-zoom-in flex flex-col items-center pointer-events-none">
                    <i data-lucide="zap" class="w-8 h-8 text-yellow-300 mb-2 fill-yellow-300"></i>
                    <span class="text-xl font-bold">Logic Match!</span>
                    <span class="text-xs text-blue-200 mt-1">Disconnected = Flexible</span>
                </div>
            </div>

            <!-- Options -->
            <div id="options-container" class="mt-8 space-y-3">
                <!-- Options injected by JS -->
            </div>
        </div>

        <!-- Right Panel: Thought Process (Visible only in Replay) -->
        <div id="thought-panel" class="hidden md:flex md:w-96 bg-slate-900 text-white flex-col shadow-2xl z-10">
            <!-- Progress Bar -->
            <div class="h-2 bg-slate-800 w-full relative">
                <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-100 ease-linear" style="width: 0%"></div>
                <!-- Markers -->
                <div class="absolute top-0 left-[12%] w-0.5 h-2 bg-white/30" title="10s"></div>
                <div class="absolute top-0 left-[37%] w-0.5 h-2 bg-white/30" title="30s"></div>
                <div class="absolute top-0 left-[68%] w-0.5 h-2 bg-white/30" title="55s"></div>
            </div>

            <div class="flex-1 p-6 flex flex-col justify-between">
                <div>
                    <div id="phase-indicator" class="flex items-center gap-2 text-blue-400 text-sm font-bold uppercase tracking-widest mb-2">
                        <i data-lucide="clock" class="w-3 h-3"></i> <span>Ready</span>
                    </div>
                    
                    <div id="thought-bubble" class="bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-inner relative mt-4 transition-all duration-300">
                        <div class="absolute -top-3 left-6 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[10px] border-b-slate-700"></div>
                        <p id="thought-text" class="text-xl font-bold leading-relaxed text-white">...</p>
                    </div>

                    <div class="mt-6 space-y-3 opacity-80">
                        <p class="text-xs text-slate-500 mb-2 font-bold uppercase">Brain Activity</p>
                        <div class="flex items-center gap-3 transition-opacity duration-300">
                            <div id="brain-dot" class="w-2 h-2 rounded-full bg-slate-600"></div>
                            <span id="brain-action" class="text-sm text-slate-400">ëŒ€ê¸° ì¤‘</span>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="bg-slate-800 rounded-xl p-4 mt-8">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-xs text-slate-400 font-bold uppercase">Controls</span>
                        <button onclick="toggleEyeTracker()" id="eye-tracker-btn" class="text-xs flex items-center gap-1 text-blue-400">
                            <i data-lucide="eye" class="w-3 h-3"></i> Tracker ON
                        </button>
                    </div>
                    <div class="flex items-center justify-between">
                        <button onclick="resetReplay()" class="p-2 hover:bg-slate-700 rounded-full text-slate-400 hover:text-white transition">
                            <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                        </button>
                        <button onclick="togglePlay()" id="play-pause-btn" class="w-14 h-14 bg-blue-600 rounded-full flex items-center justify-center text-white hover:bg-blue-500 hover:scale-105 transition shadow-lg shadow-blue-900/50">
                            <i data-lucide="play" class="w-6 h-6 ml-1"></i>
                        </button>
                        <div class="flex bg-slate-700 rounded-lg p-1" id="speed-controls">
                            <button onclick="setSpeed(0.5)" class="speed-btn px-2 py-1 text-xs font-bold rounded text-slate-400 hover:text-white" data-speed="0.5">0.5x</button>
                            <button onclick="setSpeed(1)" class="speed-btn px-2 py-1 text-xs font-bold rounded bg-slate-500 text-white" data-speed="1">1x</button>
                            <button onclick="setSpeed(2)" class="speed-btn px-2 py-1 text-xs font-bold rounded text-slate-400 hover:text-white" data-speed="2">2x</button>
                            <button onclick="setSpeed(4)" class="speed-btn px-2 py-1 text-xs font-bold rounded text-slate-400 hover:text-white" data-speed="4">4x</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Data ---
        const passageSentences = [
            { id: 1, text: "Digital platforms have ", type: "intro" },
            { id: 2, text: "made a lot of work less sticky", type: "target_phrase", underline: true }, 
            { id: 3, text: ". ", type: "text" },
            { id: 4, text: "As work becomes ever more modularised, commoditised and standardised, and as markets for digital work are created, ", type: "context" },
            { id: 5, text: "ties between service work and particular places ", type: "definition" },
            { id: 6, text: "can be disconnected", type: "definition_highlight", highlight: true }, 
            { id: 7, text: ". ", type: "text" },
            { id: 8, text: "While the business process of outsourcing that emerged in the 1990s allowed large companies to take advantage of a â€˜global reserve armyâ€™ by moving their call centres to cheap and distant labour markets, ", type: "contrast" },
            { id: 9, text: "cloudwork changes the volume and granularity at which ", type: "contrast_focus" },
            { id: 10, text: "geographically non-proximate work", type: "keyword" }, 
            { id: 11, text: " can take place. ", type: "text" },
            { id: 12, text: "A small business in New York can hire a freelance transcriber in ", type: "example" },
            { id: 13, text: "Nairobi one day and New Delhi the next", type: "example_highlight" }, 
            { id: 14, text: ". ", type: "text" },
            { id: 15, text: "No offices or factories need to be built, no local regulations are observed, and â€• in most cases â€• no local taxes are paid. ", type: "detail" }, 
            { id: 16, text: "The switch in the production network of work happens by simply sending some emails or clicking some buttons on a digital work platform. ", type: "detail" },
            { id: 17, text: "And, in this way, the employer leaves behind ", type: "conclusion" },
            { id: 18, text: "no material traces", type: "conclusion_highlight", highlight: true }, 
            { id: 19, text: " in the places where it was once an employer.", type: "text" }
        ];

        const options = [
            { id: 1, text: "settled the locational dilemma of the global markets", tag: "ë”œë ˆë§ˆ ì•„ë‹˜(X)", isAnswer: false },
            { id: 2, text: "elevated the spatial flexibility in conducting business", tag: "Logic Match! (O)", isAnswer: true },
            { id: 3, text: "weakened the geographical expansion of local business", tag: "í™•ì¥ ê°•í™”ë¨(X)", isAnswer: false },
            { id: 4, text: "relieved the strict legal processes of regional outsourcing", tag: "ë¶€ìˆ˜ì  ê²°ê³¼(â–³â†’X)", isAnswer: false },
            { id: 5, text: "allowed business to be less complicated in its hiring process", tag: "ì§€ì—½ì (X)", isAnswer: false },
        ];

        const timelineEvents = [
            { start: 0, end: 4.0, focusIds: [2], thought: "Less sticky? ëœ ëˆëˆí•˜ë‹¤? ë¬´ì–¸ê°€ì—ì„œ ë–¨ì–´ì§„ë‹¤ëŠ” ê±°ë„¤. ë°”ë¡œ ë’¤ì— ë‹µì´ ìˆê² ì§€.", phase: "íƒ€ê²ŸíŒ…", action: "scan" },
            { start: 4.0, end: 10.0, focusIds: [5, 6], thought: "Bingo. 'ì¥ì†Œ(places)ì™€ì˜ ì—°ê²°(ties)ì´ ëŠì–´ì¡Œë‹¤(disconnected)'ëŠ” ëœ»ì´êµ¬ë‚˜.", phase: "ì •ì˜ ì—°ê²°", action: "link_target_definition" },
            { start: 10.0, end: 18.0, focusIds: [8, 9], thought: "ì˜›ë‚  ì•„ì›ƒì†Œì‹±ì´ë‘ ë¹„êµí•˜ë„¤. (While...)", phase: "ëŒ€ì¡° íŒŒì•…", action: "scan" },
            { start: 18.0, end: 30.0, focusIds: [10], thought: "í•µì‹¬ì€ 'Geographically non-proximate(ì§€ë¦¬ì ìœ¼ë¡œ ê°€ê¹ì§€ ì•Šì€)'. ì¥ì†Œì— êµ¬ì• ë°›ì§€ ì•ŠëŠ”ë‹¤.", phase: "ë…¼ë¦¬ êµ¬ì²´í™”", action: "magnify_keyword" },
            { start: 30.0, end: 40.0, focusIds: [12, 13], thought: "ë‚˜ì´ë¡œë¹„ ê°”ë‹¤ê°€ ë‰´ë¸ë¦¬ ê°”ë‹¤ê°€... (ì™”ë‹¤ ê°”ë‹¤ ììœ ë¡­ë„¤)", phase: "ì˜ˆì‹œ ì‹œê°í™”", action: "visualize_example" },
            { start: 40.0, end: 48.0, focusIds: [15, 18], thought: "ì‚¬ë¬´ì‹¤ë„ í•„ìš” ì—†ê³  í”ì ë„ ì•ˆ ë‚¨ëŠ”ë‹¤. ë¬¼ë¦¬ì  ì œì•½ ì†Œë©¸.", phase: "ë‹¨ì„œ ì¬í™•ì¸", action: "read" },
            { start: 48.0, end: 55.0, focusIds: [2], thought: "ê²°ë¡ : Sticky = ì¥ì†Œ ê³ ì°©ì„±. Less sticky = ì¥ì†Œ ìœ ì—°ì„±.", phase: "ì˜ë¯¸ í™•ì •", action: "link_target_definition" },
            { start: 55.0, end: 58.0, focusIds: [], focusOption: 1, thought: "1ë²ˆ ë”œë ˆë§ˆ í•´ê²°? ë”œë ˆë§ˆ ë¬¸ì œê°€ ì•„ë‹˜. (X)", phase: "ì„ ì§€ ì†Œê±°", action: "eliminate" },
            { start: 58.0, end: 62.0, focusIds: [], focusOption: 3, thought: "3ë²ˆ í™•ì¥ ì•½í™”? ì˜¤íˆë ¤ ì „ ì„¸ê³„ë¡œ í™•ì¥ë¨. ë°˜ëŒ€. (X)", phase: "ì„ ì§€ ì†Œê±°", action: "eliminate" },
            { start: 62.0, end: 66.0, focusIds: [], focusOption: 4, thought: "4ë²ˆ ë²•ì  ì ˆì°¨ ì™„í™”? ê·¸ê±´ ê²°ê³¼ì¼ ë¿, 'Less sticky'ì˜ ì •ì˜ëŠ” ì•„ë‹˜. (í•¨ì •)", phase: "í•¨ì • íšŒí”¼", action: "trap_check" },
            { start: 66.0, end: 70.0, focusIds: [], focusOption: 2, thought: "2ë²ˆ 'Spatial flexibility'? ì§€ë¬¸ì˜ 'disconnected places', 'non-proximate'ë‘ ë”± ë§ì•„ë–¨ì–´ì§.", phase: "ì •ë‹µ ë„ì¶œ", action: "critical_option" },
            { start: 70.0, end: 76.0, focusIds: [6, 10, 18], focusOption: 2, thought: "Stickiness(ì ‘ì°©ì„±)ê°€ ì—†ìœ¼ë‹ˆ Flexible(ìœ ì—°)í•œ ê±°ì§€. ë…¼ë¦¬ ì™„ë²½í•¨.", phase: "ìµœì¢… ë§ˆí‚¹", action: "logic_match" },
            { start: 76.0, end: 80.0, focusIds: [], focusOption: 2, thought: "2ë²ˆ í™•ì • ë§ˆí‚¹.", phase: "ì¢…ë£Œ", action: "mark" }
        ];

        // --- State ---
        let mode = 'intro';
        let currentTime = 0;
        let isPlaying = false;
        let playbackSpeed = 1;
        let showEyeTracker = true;
        let solveTime = 0;
        let timerInterval = null;
        const TOTAL_DURATION = 80;

        // --- Logic & Rendering ---

        function init() {
            lucide.createIcons();
            renderPassage();
            renderOptions();
        }

        function startSolving() {
            setMode('solving');
        }

        function startReplay() {
            setMode('replay');
            currentTime = 0;
            isPlaying = true;
            startTimer();
        }

        function setMode(newMode) {
            mode = newMode;
            document.getElementById('intro-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('thought-panel').classList.remove('flex');
            document.getElementById('thought-panel').classList.add('hidden');
            document.getElementById('app-container').classList.remove('md:flex-row');
            document.getElementById('app-container').classList.add('flex-col'); // Default vertical

            if (newMode === 'intro') {
                document.getElementById('intro-screen').classList.remove('hidden');
            } else if (newMode === 'solving') {
                currentTime = 0;
                solveTime = 0;
                isPlaying = false;
                startTimer();
                updateUI();
            } else if (newMode === 'replay') {
                document.getElementById('thought-panel').classList.remove('hidden');
                document.getElementById('thought-panel').classList.add('flex');
                document.getElementById('app-container').classList.remove('flex-col');
                document.getElementById('app-container').classList.add('md:flex-row');
                updateUI();
            } else if (newMode === 'result') {
                document.getElementById('result-screen').classList.remove('hidden');
            }
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            if (isPlaying) startTimer();
            else stopTimer();
            updatePlayButton();
        }

        function startTimer() {
            stopTimer();
            timerInterval = setInterval(() => {
                if (mode === 'replay') {
                    if (isPlaying) {
                        currentTime += 0.1 * playbackSpeed;
                        if (currentTime >= TOTAL_DURATION) {
                            currentTime = TOTAL_DURATION;
                            isPlaying = false;
                            stopTimer();
                            updatePlayButton();
                        }
                        updateUI();
                    }
                } else if (mode === 'solving') {
                    solveTime += 0.1;
                    document.getElementById('timer-display').innerText = solveTime.toFixed(1) + 's';
                }
            }, 100);
            updatePlayButton();
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function resetReplay() {
            currentTime = 0;
            isPlaying = true;
            startTimer();
            updateUI();
        }

        function setSpeed(speed) {
            playbackSpeed = speed;
            document.querySelectorAll('.speed-btn').forEach(btn => {
                if (parseFloat(btn.dataset.speed) === speed) {
                    btn.classList.remove('text-slate-400');
                    btn.classList.add('bg-slate-500', 'text-white');
                } else {
                    btn.classList.add('text-slate-400');
                    btn.classList.remove('bg-slate-500', 'text-white');
                }
            });
        }

        function toggleEyeTracker() {
            showEyeTracker = !showEyeTracker;
            const btn = document.getElementById('eye-tracker-btn');
            if (showEyeTracker) {
                btn.classList.add('text-blue-400');
                btn.classList.remove('text-slate-500');
                btn.innerHTML = `<i data-lucide="eye" class="w-3 h-3"></i> Tracker ON`;
            } else {
                btn.classList.add('text-slate-500');
                btn.classList.remove('text-blue-400');
                btn.innerHTML = `<i data-lucide="eye-off" class="w-3 h-3"></i> Tracker OFF`;
            }
            lucide.createIcons();
            updateUI(); // re-render text to toggle dots
        }

        function handleOptionClick(id) {
            if (mode === 'solving') {
                stopTimer();
                const isCorrect = id === 2;
                document.getElementById('result-title').innerText = isCorrect ? "ì •ë‹µì…ë‹ˆë‹¤!" : "ì•„ì‰½ë„¤ìš”!";
                document.getElementById('result-time').innerText = solveTime.toFixed(1) + 'ì´ˆ';
                
                const iconContainer = document.getElementById('result-icon-container');
                if (isCorrect) {
                    iconContainer.className = "w-16 h-16 mx-auto rounded-full flex items-center justify-center bg-green-100 text-green-600";
                    iconContainer.innerHTML = `<i data-lucide="check-circle" class="w-10 h-10"></i>`;
                } else {
                    iconContainer.className = "w-16 h-16 mx-auto rounded-full flex items-center justify-center bg-red-100 text-red-600";
                    iconContainer.innerHTML = `<i data-lucide="x-circle" class="w-10 h-10"></i>`;
                }
                
                lucide.createIcons();
                setMode('result');
            }
        }

        // --- Rendering Helpers ---

        function updatePlayButton() {
            const btn = document.getElementById('play-pause-btn');
            if (isPlaying) {
                btn.innerHTML = `<i data-lucide="pause" class="w-6 h-6"></i>`;
            } else {
                btn.innerHTML = `<i data-lucide="play" class="w-6 h-6 ml-1"></i>`;
            }
            lucide.createIcons();
        }

        function getCurrentEvent() {
            return timelineEvents.find(e => currentTime >= e.start && currentTime < e.end) || timelineEvents[timelineEvents.length - 1];
        }

        function isFocused(id, currentEvent) {
            if (mode !== 'replay') return true;
            if (!currentEvent) return true;
            
            // Logic match shows anchors
            if (currentEvent.action === 'logic_match') return currentEvent.focusIds.includes(id);

            // Phase exclusions
            if (currentEvent.phase.includes("ì„ ì§€") || currentEvent.phase.includes("ì •ë‹µ") || currentEvent.phase.includes("í•¨ì •") || currentEvent.phase === "ì¢…ë£Œ") return false;

            return currentEvent.focusIds.includes(id);
        }

        function updateUI() {
            const currentEvent = getCurrentEvent();
            
            // 1. Update Timer Text
            const timeDisplay = mode === 'replay' ? currentTime : solveTime;
            const timerEl = document.getElementById('timer-display');
            timerEl.innerText = timeDisplay.toFixed(1) + 's';
            if (mode === 'replay') timerEl.classList.add('text-blue-600');
            else timerEl.classList.remove('text-blue-600');

            // 2. Update Passage Text
            renderPassage(currentEvent);

            // 3. Update Options
            renderOptions(currentEvent);

            // 4. Update Thought Panel (Replay Only)
            if (mode === 'replay') {
                // Progress Bar
                document.getElementById('progress-bar').style.width = `${(currentTime / TOTAL_DURATION) * 100}%`;
                
                // Thought Bubble & Phase
                document.getElementById('phase-indicator').innerHTML = `<i data-lucide="clock" class="w-3 h-3"></i> ${Math.floor(currentTime)}s / 80s - ${currentEvent.phase}`;
                document.getElementById('thought-text').innerText = `"${currentEvent.thought}"`;
                
                // Thought Bubble Style
                const bubble = document.getElementById('thought-bubble');
                if (currentEvent.action === 'link_target_definition') {
                    bubble.className = "bg-slate-800/80 p-5 rounded-2xl border border-slate-700 shadow-inner relative mt-4 ring-2 ring-red-500/50 transition-all duration-300";
                } else if (currentEvent.action === 'logic_match') {
                    bubble.className = "bg-blue-900/20 p-5 rounded-2xl border border-slate-700 shadow-inner relative mt-4 ring-2 ring-blue-500/50 transition-all duration-300";
                } else {
                    bubble.className = "bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-inner relative mt-4 transition-all duration-300";
                }

                // Brain Action
                const dot = document.getElementById('brain-dot');
                const actionText = document.getElementById('brain-action');
                
                let actionLabel = "â†’ íë¦„ ì½ê¸°";
                let dotClass = "bg-slate-600";
                let textClass = "text-slate-400";

                if (currentEvent.action === 'link_target_definition') {
                    actionLabel = "ğŸ”— ì—°ê²° ì¶”ë¡  (Linking)";
                    dotClass = "bg-red-500 animate-ping";
                    textClass = "text-red-300 font-bold";
                } else if (currentEvent.action === 'magnify_keyword') {
                    actionLabel = "ğŸ” í•µì‹¬ í‚¤ì›Œë“œ í™•ëŒ€";
                    dotClass = "bg-yellow-400";
                    textClass = "text-yellow-300 font-bold";
                } else if (currentEvent.action === 'visualize_example') {
                    actionLabel = "ğŸ–¼ï¸ ì˜ˆì‹œ ì‹œê°í™”";
                    dotClass = "bg-green-500";
                    textClass = "text-green-300 font-bold";
                } else if (currentEvent.action === 'logic_match') {
                    actionLabel = "âš¡ ë…¼ë¦¬ ì¼ì¹˜ (Match)";
                    dotClass = "bg-blue-400 animate-pulse";
                    textClass = "text-blue-300 font-bold";
                }

                dot.className = `w-2 h-2 rounded-full transition-colors duration-300 ${dotClass}`;
                actionText.className = `text-sm transition-colors duration-300 ${textClass}`;
                actionText.innerText = actionLabel;
                
                lucide.createIcons();
            }

            // Logic Match Overlay Logic
            const overlay = document.getElementById('logic-match-overlay');
            if (mode === 'replay' && currentEvent.action === 'logic_match') {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function getHighlightClass(segment, focused, currentEvent) {
            if (mode !== 'replay') return segment.underline ? 'border-b-4 border-slate-800' : '';
            
            // Action Specific Styles
            if (currentEvent?.action === 'link_target_definition') {
                if (segment.id === 2 || segment.id === 6) {
                    return 'bg-red-100 text-red-900 font-bold border-b-4 border-red-500 transition-all duration-300 shadow-sm';
                }
            }

            if (currentEvent?.action === 'magnify_keyword' && segment.id === 10) {
                return 'bg-yellow-200 text-slate-900 font-bold scale-110 shadow-lg px-2 rounded-lg ring-2 ring-yellow-400 transition-all duration-300 z-10 inline-block transform';
            }
            
            if (currentEvent?.action === 'logic_match' && focused) {
                return 'bg-blue-100 text-blue-900 font-bold px-1 rounded ring-2 ring-blue-200 transition-all duration-500';
            }

            if (!focused) return 'opacity-30 grayscale transition-all duration-500'; 

            if (currentEvent?.action === 'visualize_example') {
                return 'bg-green-50 text-slate-900 px-0 rounded transition-all duration-300';
            }
            
            return 'bg-slate-100 text-slate-900 px-0 rounded transition-all duration-300';
        }

        function renderPassage(currentEvent) {
            const container = document.getElementById('passage-body');
            // We want to preserve existing elements if possible for performance, but for this simple app, re-rendering string is fine.
            // To support overlay absolute positioning correctly, we render spans.
            
            let html = '';
            
            // Add Overlay container inside
             html += `<div id="logic-match-overlay" class="${(mode === 'replay' && currentEvent?.action === 'logic_match') ? '' : 'hidden'} absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-blue-600/90 text-white p-4 rounded-2xl shadow-2xl z-50 animate-zoom-in flex flex-col items-center pointer-events-none"><i data-lucide="zap" class="w-8 h-8 text-yellow-300 mb-2 fill-yellow-300"></i><span class="text-xl font-bold">Logic Match!</span><span class="text-xs text-blue-200 mt-1">Disconnected = Flexible</span></div>`;

            passageSentences.forEach(segment => {
                const focused = isFocused(segment.id, currentEvent);
                const classes = `segment-transition inline decoration-clone ${getHighlightClass(segment, focused, currentEvent)}`;
                
                let extraHtml = '';
                // Key Focus Badge
                if (mode === 'replay' && currentEvent?.action === 'magnify_keyword' && segment.id === 10) {
                    extraHtml += `<span class="absolute -top-6 left-1/2 -translate-x-1/2 bg-yellow-400 text-yellow-900 text-[10px] px-2 py-0.5 rounded-full font-bold whitespace-nowrap animate-bounce z-20">Key Focus!</span>`;
                }
                // Visual Cursor (Red Dot)
                if (mode === 'replay' && focused && showEyeTracker) {
                    extraHtml += `<span class="inline-block w-2 h-2 bg-red-500 rounded-full ml-0.5 align-baseline tracker-dot"></span>`;
                }
                // Arrow Animation
                if (mode === 'replay' && currentEvent?.action === 'visualize_example' && segment.id === 13) {
                     extraHtml += `<span class="absolute top-0 left-0 w-full h-full border-b-2 border-green-400 border-dashed animate-pulse pointer-events-none"></span>`;
                }

                html += `<span class="relative ${classes}">${segment.text}${extraHtml}</span>`;
            });
            
            container.innerHTML = html;
            lucide.createIcons();
        }

        function renderOptions(currentEvent) {
            const container = document.getElementById('options-container');
            let html = '';

            options.forEach(opt => {
                let containerClasses = "p-4 border-2 rounded-xl flex justify-between items-center cursor-pointer transition-all relative ";
                let badgeClasses = "w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold ";
                let eyeIcon = "";
                let tagHtml = "";

                if (mode === 'solving') {
                    containerClasses += "hover:border-blue-400 hover:bg-blue-50 border-slate-200";
                    badgeClasses += "bg-slate-200 text-slate-600";
                } else if (mode === 'replay') {
                    if (currentTime < 55) {
                        containerClasses += "opacity-40 blur-[1px] grayscale border-slate-200";
                        badgeClasses += "bg-slate-200 text-slate-600";
                    } else {
                        // Replay Active Phase
                        let isActive = false;
                        if (currentEvent?.phase === 'ì¢…ë£Œ' || currentEvent?.phase === 'ìµœì¢… ë§ˆí‚¹') {
                            if (opt.id === 2) {
                                containerClasses += "bg-blue-600 text-white border-blue-600 scale-105 shadow-lg font-bold transform";
                                badgeClasses += "bg-blue-600 text-white";
                            } else {
                                containerClasses += "opacity-20 grayscale scale-95";
                                badgeClasses += "bg-slate-200 text-slate-600";
                            }
                        } else if (currentEvent?.focusOption === opt.id) {
                            isActive = true;
                            if (opt.id === 2) {
                                containerClasses += "bg-blue-50 border-blue-500 scale-105 shadow-md font-bold ring-2 ring-blue-200 text-blue-900";
                            } else if (opt.id === 4) {
                                containerClasses += "bg-yellow-50 border-yellow-400 text-slate-700 scale-100 ring-1 ring-yellow-300";
                            } else {
                                containerClasses += "bg-slate-100 border-slate-400 text-slate-700 scale-100 ring-1 ring-slate-300";
                            }
                        } else {
                            containerClasses += "opacity-50 grayscale scale-95 border-slate-100";
                        }
                        
                        // Eye Icon
                        if (isActive) {
                             eyeIcon = `<div class="absolute -left-8 text-slate-400 animate-pulse hidden md:block"><i data-lucide="eye" class="w-5 h-5"></i></div>`;
                        }

                        // Tags
                        if (currentTime > 55 && opt.id < (currentEvent?.focusOption || 99) && currentEvent?.focusOption !== opt.id) {
                            let tagColor = "bg-slate-200 text-slate-500";
                            if (opt.isAnswer) tagColor = "bg-blue-600 text-white";
                            else if (opt.id === 4) tagColor = "bg-yellow-100 text-yellow-700";
                            
                            tagHtml = `<span class="text-xs font-bold px-2 py-1 rounded ml-2 whitespace-nowrap ${tagColor}">${opt.tag}</span>`;
                        }
                    }
                }

                html += `
                <div onclick="handleOptionClick(${opt.id})" class="${containerClasses}">
                    ${eyeIcon}
                    <div class="flex items-center gap-3">
                        <span class="${badgeClasses}">${opt.id}</span>
                        <span class="text-sm md:text-base font-medium">${opt.text}</span>
                    </div>
                    ${tagHtml}
                </div>`;
            });

            container.innerHTML = html;
        }

        // Initialize
        init();

    </script>
</body>
</html>
